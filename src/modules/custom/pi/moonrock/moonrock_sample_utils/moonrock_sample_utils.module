<?php

function _moonrock_sample_utils_sample_dialog_button($buttonClassSufix, $label) {
  return "<div class='moonrock-sample-dlg-menu-item moonrock-sample-dlg-menu-$buttonClassSufix'>"
          . "<div class='moonrock-sample-dlg-menu-item-buttom'></div><div class='moonrock-sample-dlg-menu-item-label'>$label</div></div>";
}

function moonrock_sample_utils_find_unique_seesamples_activity() {
  global $user;
  $node_details = get_inquiry_details_from_current_path();
  $sample_view_nid = find_unique_node_type_for_uid_and_inquiry('moonrock_seesamples', $user->uid, $node_details->inquiry_id);
  if ($sample_view_nid) {
    module_load_include('inc', 'moonrock_seesamples', 'moonrock_seesamples.table');
    return node_load($sample_view_nid);
  } else {
    return FALSE;
  }
}

function moonrock_sample_utils_add_info_tooltip($title, $content) {
  $output = "<span class='qtip-link'>"
          . "<div class='qtip-header'>$title</div>"
          . "<div class='qtip-tooltip'>$content</div>"
          . "<div class='moonrock-measure-info'></div>"
          . "</span>";

  return $output;
}

function moonrock_sample_utils_prepare_object($nid) {
  global $user;

  $object = node_load($nid, NULL, TRUE);
  if ($object->type == 'moonrock_sample') {
    $sample = $object;
    $snapshot = FALSE;
  } else {
    $snapshot = $object;
    $sample = node_load($snapshot->sample_ref);
  }

  $output = array(
      "id" => $snapshot ? $snapshot->nid : $sample->nid,
      "title" => $sample->title,
      "sample" => array(
          "nid" => $sample->nid,
          "image" => moonrock_snapshot_images_get_sample_url($sample->nid),
      ),
      "snapshot" => $snapshot ? array(
          "image" => moonrock_snapshot_images_get_snapshot_url($snapshot->nid),
          "vm_parameters" => $snapshot->vm_parameters,
              ) : FALSE,
      "vm" => $sample->vm,
      "metadata" => array(),
  );

  if ($snapshot) {
    if ($user->uid == $snapshot->uid) {
      $author = t("Me");
    } else {
      $author_user = user_load($snapshot->uid);
      $author = check_plain($author_user->name);
    }
    $output['metadata']['author'] = array(
        "title" => t("Created by: "),
        "value" => $author,
    );
    $output['metadata']['notes'] = array(
        "title" => t("Notes: "),
        "value" => $snapshot->notes,
    );
    $output['metadata']['date'] = array(
        "title" => t("Creation date: "),
        "value" => format_date($snapshot->created, 'small'),
    );
  }

  $output['metadata']['location'] = array(
      "title" => t("Location: "),
      "value" => $sample->location . ' <a href="' . $sample->map_url . '" target="_blank" class="external_link"><div></div></a>',
  );
  $output['metadata']['source'] = array(
      "title" => t("Sample source: "),
      "value" => $sample->source,
  );
  $output['metadata']['info'] = array(
      "title" => t("Further information:"),
      "value" => '<a href="' . $sample->info_url . '" target="_blank" class="external_link"><span>' . t('read more ') . '</span><div></div></a>',
  );
  return $output;
}

function moonrock_sample_utils_format_html_data($nid) {
  $node = node_load($nid);
  if ($node->type === 'moonrock_snapshot') {
    $img = moonrock_snapshot_images_get_snapshot_url($nid);
  } else {
    $img = moonrock_snapshot_images_get_sample_url($nid);
  }

  $title = check_plain($node->title);

  return "<img style='width: 50px' src='$img'></img><span style='padding-left: 10px;'>$title</span>";
}

function moonrock_sample_utils_activity_link($type) {
  global $user;
  $details = get_inquiry_details_from_current_path();
  $activity_id = get_activity_ids_for_activity_type($details->inquiry_id, $type, $user->uid);
  $phase_id = get_phase_id_for_activity_id($activity_id);
  return build_activity_link($details->inquiry_id, $details->stage_id, $phase_id, $activity_id, $user->uid);
}

function moonrock_sample_utils_load_measure_format() {
  drupal_add_css(drupal_get_path('module', 'moonrock_sample_utils') . '/css/measures.css');
}

function moonrock_sample_utils_load_vmSample_format() {
  drupal_add_css(drupal_get_path('module', 'moonrock_sample_utils') . '/css/external_link.css');
  drupal_add_css(drupal_get_path('module', 'moonrock_sample_utils') . '/css/vmSample.css');
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/vmSample.js');
}

function moonrock_sample_utils_load_falseblock_format() {
  drupal_add_css(drupal_get_path('module', 'moonrock_sample_utils') . '/css/falseblock.css');
}

function moonrock_sample_utils_theme() {
  return array(
      'moonrock_sample_utils_page_with_block' => array(
          'arguments' => array('page', 'blocks'),
      ),
      'moonrock_sample_utils_measure_info' => array(
          'arguments' => array('measure_info'),
      ),
      'moonrock_sample_utils_fuzzy_time_period' => array(
          'arguments' => array('time'),
      ),
  );
}

function theme_moonrock_sample_utils_page_with_block($page, $blocks) {

  moonrock_sample_utils_load_falseblock_format();

  $output = '<div class="moonrock-sample-utils-pageblock-container">'
          . ' <div class="moonrock-sample-utils-pageblock-page">'
          . $page
          . ' </div>'
          . ' <div class="moonrock-sample-utils-pageblock-blocks">';
  foreach ($blocks as $block) {
    $output .= '  <div class="moonrock-sample-utils-pageblock-falseblock" id="' . $block['id'] . '">'
            . '   <h2 class="title">' . $block['title'] . '</h2>'
            . '   <div class="content">' . $block['content'] . '</div>'
            . '  </div>';
  }
  $output .= ' </div>'
          . '</div>';

  return $output;
}

function theme_moonrock_sample_utils_measure_info($measure_info) {
  moonrock_sample_utils_load_measure_format();

  if (isset($measure_info->units_short) AND ($measure_info->units_short != '')) {
    $units = " (" . $measure_info->units_short . ")";
  } elseif (isset($measure_info->units) AND ($measure_info->units != '')) {
    $units = " (" . $measure_info->units . ")";
  } else {
    $units = "";
  };

  return '<div class="moonrock-measure-title">'
          . check_plain($measure_info->title . $units) . moonrock_sample_utils_add_info_tooltip($measure_info->title, $measure_info->body)
          . '</div>';
}

function moonrock_sample_utils_load_item_browser_resources() {
  moonrock_sample_utils_load_mouse_input();

  drupal_add_css(drupal_get_path('module', 'moonrock_sample_utils') . '/css/itemBrowser.css');
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/jquery.itemBrowser.js');
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/jquery.itemBrowserThrobber.js');
}

function moonrock_sample_utils_load_mouse_input() {
  jquery_ui_add();
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/jquery.proxy.js');
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/jquery.mousewheel.js');
  drupal_add_js(drupal_get_path('module', 'moonrock_sample_utils') . '/js/jquery.customMouseInput.js');
}

function theme_moonrock_sample_utils_fuzzy_time_period($time) {
  if ($time < 30) {
    return t('a few seconds ago');
  }

  $periods = array(
      array(
          'm' => 60,
          's' => t('a minute'),
          'p' => t('minutes'),
      ),
      array(
          'm' => 24,
          's' => t('an hour'),
          'p' => t('hours'),
      ),
      array(
          'm' => 7,
          's' => t('a day'),
          'p' => t('days'),
      ),
      array(
          'm' => 4,
          's' => t('a week'),
          'p' => t('days'),
      ),
      array(
          'm' => 12,
          's' => t('a month'),
          'p' => t('months'),
      ),
      array(
          'm' => -1,
          's' => t('a year'),
          'p' => t('years'),
      ),
  );
  
  $time = (int) ($time / 60);
  
  for($i = 0; $i < count($periods); $i++) {
    if ($time < 2) {
      return $periods[$i]['s'] . t(' ago');
    } 
    if (!isset($periods[$i]['m']) || $time <  $periods[$i]['m']) {
      return $time . ' ' . $periods[$i]['p'] . t(' ago');
    }
    $time = (int) ($time / $periods[$i]['m']);
  }
  
  return 'unknown time!';
}
